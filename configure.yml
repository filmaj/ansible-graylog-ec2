---
- name: Configure graylog instance
  tags: configure
  hosts: metrics
  vars:
    metrics_disk: /dev/xvdb                          # the disk device where we will store metrics
    set_graylog_admin_password: ""                   # when set via the command line, configures the graylog administrator password
    graylog_pass: "{{ set_graylog_admin_password }}" # defaults to the admin password we want to set, if set.
  remote_user: ubuntu
  become: yes

  tasks:
  - name: Ensure password for Graylog was provided
    fail: msg="Please provide an admin password for Graylog, either via the graylog_pass variable, or if you would like to set a new password to the Graylog instance, via the set_admin_graylog_password variable."
    when: graylog_pass | trim == ''
  - name: Set hostname
    hostname:
      name: phonegap-metrics
    notify:
      - restart rsyslog
  - name: Ensure hostfile is correct
    lineinfile:
      dest: /etc/hosts
      owner: root
      group: root
      mode: 0644
      line: "127.0.0.1 phonegap-metrics"
      state: present
      create: yes
    notify:
      - restart rsyslog
  - name: Ensure EBS volume has a filesystem
    filesystem:
      fstype: ext4
      dev: "{{ metrics_disk }}"
      force: no
  - name: Mount EBS volume
    mount:
      name: /var/opt/graylog/data
      src: "{{ metrics_disk }}"
      fstype: ext4
      state: mounted
  - name: Ensure NTP service is running
    service:
      name: ntp
      state: started
  - name: Baseline graylog configuration
    shell: |
      graylog-ctl set-timezone UTC \
      && graylog-ctl set-external-ip "https://{{ inventory_hostname }}:443/api/" \
      && graylog-ctl enforce-ssl
    args:
      creates: /etc/graylog/graylog-settings.json
    notify:
      - reconfigure graylog
  - name: Set graylog admin password
    shell: graylog-ctl set-admin-password "{{ set_graylog_admin_password }}" \
    notify:
      - reconfigure graylog
    when: not(set_graylog_admin_password | trim == '')
  - name: Ensure pip is installed
    # TODO: this installs a bad version of pip!
    # use https://odedrabhavesh.blogspot.mx/2017/02/importerror-no-module-named.html
    apt:
      name: python-pip
      state: present
  - name: Ensure httplib2 is installed
    pip:
      name: httplib2
      state: latest

  handlers:
    - name: reconfigure graylog
      command: graylog-ctl reconfigure

    - name: restart rsyslog
      service: name=rsyslog state=restarted

    - name: restart elasticsearch
      command: graylog-ctl restart elasticsearch

    - name: restart nginx
      command: graylog-ctl restart nginx
